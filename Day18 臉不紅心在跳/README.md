# 臉不紅心在跳

> 以 rPPG（remote Photoplethysmography）偵測影片或相機中的心率，並用炫酷 UI 顯示熱力圖與 3D 心臟同步跳動。  
> **非醫療用途**。

## 功能
- ✅ 上傳影片或即時攝影機串流
- ✅ 臉部 ROI（額頭）偵測、rPPG 訊號萃取（CHROM + Green 融合）
- ✅ 頻帶濾波（0.7–3.0 Hz）＋ Welch PSD 求峰值得到 BPM
- ✅ 類 EVM 的臉部紅潤熱力圖（時間帶通 FIR 在 ROI 維度累積）
- ✅ 3D 心臟（Three.js）依 BPM 脈動
- ✅ 量測紀錄 **新增／修改／刪除**（最小 JSON DB）
- ✅ 影片離線處理進度條與疊加輸出影片下載
- ✅ 單元測試（訊號估測、API CRUD）含邊界情境

## 參考與方法
UI 與方法參照 *How to detect Heart Rate in Videos* 一文中的 EVM（Eulerian Video Magnification）思路：先在色彩空間與金字塔層上做時間濾波，再將放大後的時變訊號疊回畫面；文中也展示了頻帶濾波器的頻率響應以及轉移函數的概念，我們採用類似的帶通策略來聚焦於心率頻帶，並視覺化為臉部紅潤熱力圖。fileciteturn1file0

> 提示：環境光、鏡頭曝光與人臉移動會顯著影響 rPPG 訊噪比。錄製時盡量保持穩定、充足光源、臉部正對鏡頭。

## 安裝與一鍵啟動（Windows）
1. 下載或解壓本專案。
2. 直接執行 `run.bat`（會自動建立虛擬環境、安裝相依套件並啟動伺服器）。
3. 開啟瀏覽器到 `http://127.0.0.1:8000/`。

> *bat* 以 **CRLF** 換行、**Big5（cp950）** 編碼保存，失敗時不會閃退而會輸出錯誤訊息。

## 使用
- **開啟攝影機**：授權後左側即顯示預覽，右側即時顯示 BPM、信號波形與心臟動畫。
- **上傳影片**：支援 `mp4/mov` 等格式，上傳後會顯示進度條，完成可下載有熱力圖與 BPM 註記的疊加影片。
- **紀錄管理**：可新增／選用紀錄，量測中自動把 (timestamp, bpm, conf) 寫入。可修改名稱或刪除。

## 參數
- 頻率帶：`0.7–3.0 Hz`（約 42–180 BPM），可在 `hr/rppg.py` 調整。
- 視窗長度：預設 15 s（PSD 估測更穩定）。

## 測試
```
pip install -r requirements.txt
pytest -q
```

## 限制
- 目前使用 Haar cascade 臉偵測；要更高魯棒性可換用 ONNX 的 RetinaFace/CenterFace。
- 熱力圖為 ROI 的時間濾波能量，並非真正血紅素濃度地圖；視覺化為演示用途。
- **非醫療器材**，請勿作為診療依據。
